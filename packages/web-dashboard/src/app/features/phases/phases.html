<div class="phases" data-testid="phases-page">
  <!-- Header with stats -->
  <div class="phases__header">
    <div class="phases__title-section">
      <h2 class="phases__title">Phase Tree</h2>
      <p class="phases__subtitle">Hierarchical view of project phases</p>
    </div>
    <div class="phases__stats">
      <span class="phases__stat" data-testid="total-phases">
        <span class="phases__stat-value">{{ totalPhases() }}</span>
        <span class="phases__stat-label">Total</span>
      </span>
      <span class="phases__stat phases__stat--success" data-testid="completed-phases">
        <span class="phases__stat-value">{{ completedPhases() }}</span>
        <span class="phases__stat-label">Completed</span>
      </span>
      <span class="phases__stat phases__stat--info" data-testid="in-progress-phases">
        <span class="phases__stat-value">{{ inProgressPhases() }}</span>
        <span class="phases__stat-label">In Progress</span>
      </span>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="phases__toolbar">
    <p-button
      [label]="allExpanded() ? 'Collapse All' : 'Expand All'"
      [icon]="allExpanded() ? 'pi pi-minus' : 'pi pi-plus'"
      severity="secondary"
      [outlined]="true"
      size="small"
      (click)="toggleExpandAll()"
      data-testid="toggle-expand-btn" />
    <p-button
      icon="pi pi-refresh"
      severity="secondary"
      [outlined]="true"
      size="small"
      pTooltip="Refresh"
      (click)="loadPhaseTree()"
      data-testid="refresh-btn" />
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="phases__loading" data-testid="loading-indicator">
      <i class="pi pi-spin pi-spinner phases__loading-icon"></i>
      <span class="phases__loading-text">Loading phase tree...</span>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <p-card styleClass="phases__error-card">
      <div class="phases__error" data-testid="error-message">
        <i class="pi pi-exclamation-triangle phases__error-icon"></i>
        <span class="phases__error-text">{{ error() }}</span>
        <p-button
          label="Retry"
          icon="pi pi-refresh"
          severity="secondary"
          size="small"
          (click)="loadPhaseTree()" />
      </div>
    </p-card>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && treeNodes().length === 0) {
    <p-card styleClass="phases__empty-card">
      <div class="phases__empty" data-testid="empty-state">
        <i class="pi pi-inbox phases__empty-icon"></i>
        <span class="phases__empty-text">No phases found</span>
        <span class="phases__empty-hint">Create phases in your plan to see them here</span>
      </div>
    </p-card>
  }

  <!-- Tree Table -->
  @if (!loading() && !error() && treeNodes().length > 0) {
    <div
      class="phases__tree-container"
      data-testid="phases-tree-container"
      scrollContainer
      [enableVertical]="true"
      [enableHorizontal]="false"
    >
      <p-treetable
        [value]="treeNodes()"
        styleClass="phases__tree p-treetable-sm"
        (onNodeExpand)="onNodeExpand($event)"
        data-testid="phase-tree">
        <ng-template pTemplate="header">
          <tr>
            <th class="phases__col-title">Title</th>
            <th class="phases__col-status">Status</th>
            <th class="phases__col-progress">Progress</th>
            <th class="phases__col-priority">Priority</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
          <tr [ttRow]="rowNode" class="phases__row phases__row--{{ rowData.status }}">
            <!-- Title Column with Tree Toggle -->
            <td class="phases__cell-title">
              <p-treeTableToggler [rowNode]="rowNode" />
              <div class="phases__title-content">
                <span class="phases__path" data-testid="phase-path">{{ rowData.path }}</span>
                <span class="phases__name" [pTooltip]="rowData.description" tooltipPosition="top">
                  {{ rowData.title }}
                </span>
                @if (rowData.status === 'blocked' && rowData.blockingReason) {
                  <span class="phases__blocker-hint" pTooltip="{{ rowData.blockingReason }}">
                    <i class="pi pi-exclamation-circle"></i>
                  </span>
                }
              </div>
            </td>

            <!-- Status Column -->
            <td class="phases__cell-status">
              <p-tag
                [value]="getStatusLabel(rowData.status)"
                [severity]="getStatusSeverity(rowData.status)"
                [rounded]="true"
                data-testid="phase-status" />
            </td>

            <!-- Progress Column -->
            <td class="phases__cell-progress">
              <div class="phases__progress-wrapper" [class]="getProgressBarClass(rowData.progress ?? 0)">
                <p-progressBar
                  [value]="rowData.progress ?? 0"
                  [showValue]="false"
                  styleClass="phases__progress-bar" />
                <span class="phases__progress-value" data-testid="phase-progress">
                  {{ rowData.progress ?? 0 }}%
                </span>
              </div>
            </td>

            <!-- Priority Column -->
            <td class="phases__cell-priority">
              @if (rowData.priority) {
                <p-tag
                  [value]="rowData.priority"
                  [severity]="getPrioritySeverity(rowData.priority)"
                  [rounded]="true"
                  data-testid="phase-priority" />
              } @else {
                <span class="phases__no-priority">-</span>
              }
            </td>
          </tr>
        </ng-template>
      </p-treetable>
    </div>
  }
</div>

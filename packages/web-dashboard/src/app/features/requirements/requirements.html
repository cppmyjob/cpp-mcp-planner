<div class="requirements" data-testid="requirements-page">
  <!-- Toolbar -->
  <div class="requirements__toolbar">
    <h2 class="requirements__title">Requirements</h2>

    <div class="requirements__toolbar-actions">
      <span class="p-input-icon-left">
        <i class="pi pi-search"></i>
        <input
          pInputText
          type="text"
          placeholder="Search..."
          [ngModel]="searchTerm()"
          (ngModelChange)="searchTerm.set($event)"
          data-testid="requirements-search"
          class="requirements__search"
        />
      </span>

      <p-button
        label="Filter"
        icon="pi pi-filter"
        [outlined]="true"
        severity="secondary"
        data-testid="requirements-filter-button"
      />

      <p-button
        label="Sort"
        icon="pi pi-sort-alt"
        [outlined]="true"
        severity="secondary"
        data-testid="requirements-sort-button"
      />

      <p-button
        label="Add Requirement"
        icon="pi pi-plus"
        (onClick)="openAddDialog()"
        data-testid="add-requirement-button"
      />
    </div>
  </div>

  <!-- Loading state -->
  @if (loading()) {
    <div class="requirements__loading" data-testid="requirements-loading">
      <i class="pi pi-spin pi-spinner requirements__loading-icon"></i>
      <p class="requirements__loading-text">Loading requirements...</p>
    </div>
  }

  <!-- Error state -->
  @if (error()) {
    <div class="requirements__error" data-testid="requirements-error">
      <i class="pi pi-exclamation-triangle requirements__error-icon"></i>
      <p class="requirements__error-text">{{ error() }}</p>
    </div>
  }

  <!-- Kanban Board -->
  @if (!loading() && !error()) {
    <div class="requirements__kanban" data-testid="requirements-kanban">
      @for (column of kanbanColumns(); track column.status) {
        <div
          class="kanban-column"
          [attr.data-testid]="'kanban-column-' + column.status"
          pDroppable="requirements"
          (onDrop)="onDrop(column.status)"
        >
          <!-- Column Header -->
          <div class="kanban-column__header" [attr.data-testid]="'column-header-' + column.status">
            <span class="kanban-column__title">{{ column.title }}</span>
            <span class="kanban-column__count" [attr.data-testid]="'column-count-' + column.status">
              ({{ column.requirements.length }})
            </span>
          </div>

          <!-- Column Cards -->
          <div class="kanban-column__cards">
            @for (requirement of column.requirements; track requirement.id) {
              <div
                class="requirement-card"
                pDraggable="requirements"
                (onDragStart)="onDragStart(requirement)"
                (onDragEnd)="onDragEnd()"
                [attr.data-testid]="'requirement-card-' + requirement.id"
              >
                <!-- Card Header: REQ-ID -->
                <div class="requirement-card__id" data-testid="requirement-id">
                  {{ getReqId(requirement) }}
                </div>

                <!-- Separator -->
                <div class="requirement-card__separator"></div>

                <!-- Title -->
                <h4 class="requirement-card__title" data-testid="requirement-title">
                  {{ requirement.title }}
                </h4>

                <!-- Description (truncated) -->
                @if (requirement.description) {
                  <p class="requirement-card__description" data-testid="requirement-description">
                    {{ requirement.description }}
                  </p>
                }

                <!-- Covered by (only for implemented) -->
                @if (getCoveredBy(requirement).length > 0) {
                  <div class="requirement-card__coverage" data-testid="requirement-coverage">
                    @for (solution of getCoveredBy(requirement); track solution.id) {
                      <span class="requirement-card__covered-by">
                        Covered by {{ getSolutionId(solution) }}
                      </span>
                    }
                  </div>
                }

                <!-- Footer: Priority, Votes, Tags -->
                <div class="requirement-card__footer">
                  <!-- Priority -->
                  <p-tag
                    [value]="requirement.priority"
                    [severity]="getPrioritySeverity(requirement.priority)"
                    data-testid="requirement-priority"
                    class="requirement-card__priority"
                  />

                  <!-- Votes -->
                  <span class="requirement-card__votes" data-testid="requirement-votes">
                    {{ requirement.votes }} votes
                  </span>
                </div>

                <!-- Tags -->
                @if (getTags(requirement).length > 0) {
                  <div class="requirement-card__tags" data-testid="requirement-tags">
                    @for (tag of getTags(requirement); track tag) {
                      <p-chip [label]="tag" class="requirement-card__tag" />
                    }
                  </div>
                }
              </div>
            }

            <!-- Empty state -->
            @if (column.requirements.length === 0) {
              <div class="kanban-column__empty" [attr.data-testid]="'column-empty-' + column.status">
                <span class="kanban-column__empty-text">No {{ column.title.toLowerCase() }} requirements</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Add Requirement Dialog -->
  <p-dialog
    header="Add Requirement"
    [(visible)]="showAddDialog"
    [modal]="true"
    [style]="{ width: '50vw' }"
    [draggable]="false"
    [resizable]="false"
    data-testid="add-requirement-dialog"
  >
    <div class="add-requirement-form">
      <!-- Title -->
      <div class="add-requirement-form__field">
        <label for="req-title" class="add-requirement-form__label">
          Title <span class="add-requirement-form__required">*</span>
        </label>
        <input
          id="req-title"
          pInputText
          type="text"
          [(ngModel)]="newRequirement().title"
          placeholder="Enter requirement title"
          data-testid="requirement-title-input"
          class="w-full"
        />
      </div>

      <!-- Description -->
      <div class="add-requirement-form__field">
        <label for="req-description" class="add-requirement-form__label">Description</label>
        <textarea
          id="req-description"
          pTextarea
          [(ngModel)]="newRequirement().description"
          placeholder="Enter requirement description"
          data-testid="requirement-description-input"
          rows="4"
          class="w-full"
        ></textarea>
      </div>

      <!-- Priority -->
      <div class="add-requirement-form__field">
        <label for="req-priority" class="add-requirement-form__label">Priority</label>
        <p-select
          id="req-priority"
          [(ngModel)]="newRequirement().priority"
          [options]="priorityOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select priority"
          data-testid="requirement-priority-select"
          class="w-full"
        />
      </div>

      <!-- Category -->
      <div class="add-requirement-form__field">
        <label for="req-category" class="add-requirement-form__label">Category</label>
        <p-select
          id="req-category"
          [(ngModel)]="newRequirement().category"
          [options]="categoryOptions"
          optionLabel="label"
          optionValue="value"
          placeholder="Select category"
          data-testid="requirement-category-select"
          class="w-full"
        />
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        [outlined]="true"
        (onClick)="showAddDialog.set(false)"
        severity="secondary"
      />
      <p-button
        label="Save"
        icon="pi pi-check"
        (onClick)="saveRequirement()"
        data-testid="requirement-save-button"
      />
    </ng-template>
  </p-dialog>

  <!-- Toast notifications -->
  <p-toast />
</div>
